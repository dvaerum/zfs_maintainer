#!/usr/bin/env sh
set -eux

LOG_FILE="/post_patchmgmt.log"

exec 3>&1 4>&2
trap 'exec 2>&4 1>&3' 0 1 2 3
exec 1>${LOG_FILE} 2>&1

get_cmdline_value() {
    local key="$1"
    local value
    value="$(cat /proc/cmdline | sed -e 's/ /\n/g' | grep "^${key}=" | cut -d= -f2)"
    echo "${value}"
}

FS_SUFFIX_NEXT_BOOT="_next_boot"
FS_SUFFIX_OLD_BOOT="_old_boot"

ZPOOL_NAME="$(get_cmdline_value rpool)"
ZPOOL_BOOTFS="$(zpool get -H bootfs "${ZPOOL_NAME}" | awk '{printf("%s", $3)}')"

_GRUB_BOOT_IMAGE="$(get_cmdline_value BOOT_IMAGE)"
GRUB_BOOT_IMAGE="${ZPOOL_NAME}${_GRUB_BOOT_IMAGE%@*}"

ZFS_BOOT="${ZPOOL_BOOTFS%${FS_SUFFIX_NEXT_BOOT}}"
ZFS_BOOT_OLD="${ZFS_BOOT}${FS_SUFFIX_OLD_BOOT}"


if [[ "${ZPOOL_BOOTFS}" =~ ${FS_SUFFIX_NEXT_BOOT}$ ]]; then
    zfs rename "${ZFS_BOOT}" "${ZFS_BOOT_OLD}"
    zfs rename "${ZPOOL_BOOTFS}" "${ZFS_BOOT}"
    zfs promote "${ZFS_BOOT}"
fi
