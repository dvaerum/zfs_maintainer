# ex: set tabstop=8 softtabstop=0 expandtab shiftwidth=2 smarttab:
---
- hosts: localhost
  connection: local
  gather_facts: true

  vars:
    root_zfs_pool: "{{ ansible_cmdline.rpool }}"
    distro_filesystem_path: "{{ root_zfs_pool }}/ROOT/{{ ansible_distribution }}"
    distro_snapshot_path: "{{ root_zfs_pool }}/ROOT/{{ ansible_distribution }}@before_upgrade"
    distro_next_boot_path: "{{ distro_filesystem_path }}_next_boot"
    grub_filesystem_path: "{{ root_zfs_pool }}/data/grub"

### TODO: this feature is not implemented yet
#    snapshots:
#      - "{{ grub_filesystem_path }}"

  tags:
    - pre_patch

  roles:
    - name: Verify The System
      role: verify_system
      vars:
        root_user: "{{ ansible_user_uid == 0 }}"
      tags:
        - verify_system

    - name: Don't Run As The Root User
      role: stop_if_root
      tags:
        - stop_if_root

    - name: Snapshot & Clone The ROOT (/) Filesystem
      role: snapshot_and_clone
      tags:
        - zfs_checks

    - name: Unmount The List of Binds (in case they was mounted - can easily happen in testing)
      role: umount_binds
      tags:
        - mount_binds

    - name: Mount The List of Binds
      role: mount_binds
      tags:
        - mount_binds


- hosts: sudo_chroot
  gather_facts: true
  vars:
    distro_filesystem_path_without_zpool: "/ROOT/{{ ansible_distribution }}_next_boot"

  tags:
    - patch

  roles:
    - name: Upgrade All Packages
      role: patch
      tags:
        - patch_upgrade

    - name: Generate new grub.cfg
      role: grub_mkconfig
      tags:
        - patch_grub


- hosts: localhost
  gather_facts: true
  vars:
    root_zfs_pool: "{{ ansible_cmdline.rpool }}"
    distro_filesystem_path: "{{ root_zfs_pool }}/ROOT/{{ ansible_distribution }}"
    distro_snapshot_path: "{{ root_zfs_pool }}/ROOT/{{ ansible_distribution }}@before_upgrade"
    distro_next_boot_path: "{{ distro_filesystem_path }}_next_boot"

  tags:
    - post_patch

  roles:
    - name: Don't Run As The Root User
      role: stop_if_root
      tags:
        - stop_if_root

#    - name: Make Sure That The Folder /tmp in chroot The Envirement is Emply
#      role: clean_chroot_tmp
#      tags:
#        - clean_chroot_tmp

    - name: Unmount The (ZFS) next_boot
      role: unmount_next_boot
      tags:
        - unmount_next_boot

  post_tasks:
    - name: Set bootfs (zpool prop) to the next_boot
      command: "sudo zpool set bootfs='{{ distro_next_boot_path }}' '{{ root_zfs_pool }}'"
      args:
        warn: no
      tags:
        - update_bootfs


